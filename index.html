<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GitHub OAuth è®¤è¯</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;
    }
    .container { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 500px; width: 100%; overflow: hidden; }
    .header { background: #333; color: white; padding: 30px; text-align: center; }
    .header h1 { font-size: 28px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .github-icon { width: 40px; height: 40px; fill: white; }
    .content { padding: 30px; }
    .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
    .config-section { background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    .config-title { font-weight: 600; color: #1565c0; margin-bottom: 10px; }
    .config-input { width: 100%; padding: 10px; border: 1px solid #90caf9; border-radius: 5px; margin-bottom: 10px; }
    .config-help { font-size: 12px; color: #666; }
    .login-btn { background: #24292e; color: white; border: none; padding: 15px 30px; font-size: 16px; border-radius: 8px; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; width: 100%; justify-content: center; transition: all 0.3s ease; }
    .login-btn:hover { background: #0366d6; transform: translateY(-2px); }
    .loading { display: none; text-align: center; padding: 20px; }
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .user-info { display: none; }
    .user-avatar { width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 20px; display: block; border: 4px solid #f0f0f0; }
    .user-details { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    .detail-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e0e0e0; }
    .detail-item:last-child { border-bottom: none; }
    .detail-label { color: #666; font-size: 14px; }
    .detail-value { color: #333; font-weight: 500; font-size: 14px; word-break: break-all; }
    .token-section { background: #fff3cd; border: 1px solid #ffc107; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
    .token-title { font-weight: 600; color: #856404; }
    .token-value { background: white; padding: 10px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 12px; word-break: break-all; margin-top: 10px; }
    .copy-btn { background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; }
    .copy-btn:hover { background: #218838; }
    .logout-btn { background: #dc3545; color: white; border: none; padding: 12px; font-size: 16px; border-radius: 8px; cursor: pointer; width: 100%; }
    .logout-btn:hover { background: #c82333; }
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; background: #d4edda; color: #155724; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>
        <svg class="github-icon" viewBox="0 0 24 24">
          <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
        </svg>
        GitHub OAuth è®¤è¯
      </h1>
      <p>å®‰å…¨è·å– Access Token</p>
    </div>

    <div class="content">
      <div class="error" id="error-message"></div>

      <div class="config-section" style="display:none;">
        <div class="config-title">åº”ç”¨é…ç½®</div>
        <input type="text" id="client-id" class="config-input" value="Ov23liShK8kmAipWUYCw"> <!-- å†…ç½® Client ID -->
        <div class="config-help">
          å›è°ƒåœ°å€: <code id="callback-url"></code><br>
          <small>åç«¯: <code>https://02oauth-backend.netlify.app/.netlify/functions/token</code></small>
        </div>
      </div>

      <div class="loading" id="auto-start-message" style="display:block; text-align:center; padding:20px;">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: #666;">æ­£åœ¨å¯åŠ¨ GitHub è®¤è¯...</p>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: #666;">æ­£åœ¨å¤„ç†è®¤è¯...</p>
      </div>

      <div class="user-info" id="user-info">
        <img id="user-avatar" class="user-avatar" src="" alt="Avatar">
        <div class="user-details">
          <h3>ç”¨æˆ·ä¿¡æ¯</h3>
          <div class="detail-item"><span class="detail-label">ç”¨æˆ·å</span><span class="detail-value" id="username">-</span></div>
          <div class="detail-item"><span class="detail-label">å§“å</span><span class="detail-value" id="name">-</span></div>
          <div class="detail-item"><span class="detail-label">é‚®ç®±</span><span class="detail-value" id="email">-</span></div>
          <div class="detail-item"><span class="detail-label">å…¬å¼€ä»“åº“</span><span class="detail-value" id="public-repos">-</span></div>
          <div class="detail-item"><span class="detail-label">çŠ¶æ€</span><span class="status-badge" id="token-status">æœ‰æ•ˆ</span></div>
        </div>
        <div class="token-section">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span class="token-title">Access Token</span>
            <button class="copy-btn" onclick="copyToken()">å¤åˆ¶</button>
          </div>
          <div class="token-value" id="token-value">-</div>
        </div>
        <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </div>

  <script>
    // ç”ŸæˆOAuthå“ˆå¸Œï¼ˆä¸æ¡Œé¢ç«¯ä½¿ç”¨ç›¸åŒç®—æ³•ï¼‰
    function generateOAuthHash() {
      const timestamp = getCurrentTimestamp();
      const deviceInfo = getDeviceInfo();
      const data = `${deviceInfo}_${timestamp}`;
      
      // ä½¿ç”¨Web Crypto APIè¿›è¡ŒSHA256å“ˆå¸Œ
      const encoder = new TextEncoder();
      const dataBuffer = encoder.encode(data);
      return window.crypto.subtle.digest('SHA-256', dataBuffer).then(hashBuffer => {
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return `${hashHex}_${timestamp}`;
      });
    }

    // è·å–è®¾å¤‡ä¿¡æ¯ï¼ˆä¸æ¡Œé¢ç«¯å…¼å®¹ï¼‰
    function getDeviceInfo() {
      const platform = getPlatform();
      const arch = getArchitecture();
      const timezone = getTimezone();
      return `plat_${platform}_arch_${arch}_tz_${timezone}`.replace(/[^a-zA-Z0-9]/g, '');
    }

    // è·å–å¹³å°ä¿¡æ¯
    function getPlatform() {
      const userAgent = navigator.userAgent.toLowerCase();
      if (userAgent.includes('win')) return 'win32';
      if (userAgent.includes('mac')) return 'darwin';
      if (userAgent.includes('linux')) return 'linux';
      return 'unknown';
    }

    // è·å–æ¶æ„ä¿¡æ¯
    function getArchitecture() {
      const userAgent = navigator.userAgent;
      if (userAgent.includes('x86_64') || userAgent.includes('amd64')) return 'x64';
      if (userAgent.includes('arm64') || userAgent.includes('aarch64')) return 'arm64';
      return 'unknown';
    }

    // è·å–æ—¶åŒºä¿¡æ¯
    function getTimezone() {
      const offset = new Date().getTimezoneOffset();
      return `tz_${offset}`.replace(/[^a-zA-Z0-9]/g, '').substring(0, 10);
    }

    // è·å–å½“å‰æ—¶é—´æˆ³ï¼ˆåˆ†é’Ÿçº§ç²¾åº¦ï¼‰
    function getCurrentTimestamp() {
      const now = Date.now();
      return Math.floor(now / (1000 * 60)) * 60 * 1000;
    }

    // è·å–URLå‚æ•°ä¸­çš„å“ˆå¸Œæˆ–ç”Ÿæˆæ–°çš„å“ˆå¸Œ
    const urlParams = new URLSearchParams(window.location.search);
    const urlHash = urlParams.get('hash');
    
    // æ­£ç¡®åç«¯åœ°å€
    const BACKEND_URL = 'https://02engine-desktop-oauth-backend.netlify.app/.netlify/functions/token';
    const REDIRECT_URI = window.location.origin + window.location.pathname;
    document.getElementById('callback-url').textContent = REDIRECT_URI;
    
    // ä½¿ç”¨å›ºå®šhashï¼ˆä¸åŠ¨æ€å˜åŒ–ï¼‰
    let oauthHash = urlHash;
    
    // å¦‚æœæ²¡æœ‰URL hashï¼Œç”Ÿæˆå›ºå®šhash
    if (!oauthHash) {
      console.log('ğŸ”§ [OAuth-Between] æ²¡æœ‰URL hashï¼Œå¼€å§‹ç”Ÿæˆ');
      // ä½¿ç”¨é¡µé¢åŠ è½½æ—¶çš„å›ºå®šæ—¶é—´æˆ³
      const initTime = Math.floor(Date.now() / (1000 * 60)) * 60 * 1000;
      const deviceInfo = getDeviceInfo();
      const data = `${deviceInfo}_${initTime}`;
      
      console.log(`ğŸ“Š [OAuth-Between] ç”Ÿæˆå‚æ•°: deviceInfo=${deviceInfo}, timestamp=${initTime}, data=${data}`);
      
      // ä½¿ç”¨ä¸æ¡Œé¢ç«¯ç›¸åŒçš„å“ˆå¸Œç®—æ³•
      const encoder = new TextEncoder();
      const dataBuffer = encoder.encode(data);
      window.crypto.subtle.digest('SHA-256', dataBuffer).then(hashBuffer => {
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        oauthHash = `${hashHex}_${initTime}`;
        console.log(`âœ… [OAuth-Between] ç”Ÿæˆå…¼å®¹çš„OAuth Hash: ${oauthHash}`);
      }).catch(err => {
        console.error(`âŒ [OAuth-Between] SHA-256è®¡ç®—å¤±è´¥:`, err);
      });
      
      // å¦‚æœæ²¡æœ‰å¼‚æ­¥ç”Ÿæˆï¼Œåˆ™ä½¿ç”¨é»˜è®¤hash
      setTimeout(() => {
        if (!oauthHash) {
          console.log('ğŸ”„ [OAuth-Between] ä½¿ç”¨å¤‡ç”¨å“ˆå¸Œç”Ÿæˆæ–¹æ³•');
          const defaultData = `plat_${getPlatform()}_arch_${getArchitecture()}_tz_${getTimezone()}_${initTime}`.replace(/[^a-zA-Z0-9]/g, '').substring(0, 10);
          const defaultHash = btoa(defaultData).replace(/[^a-zA-Z0-9]/g, '').substring(0, 32);
          oauthHash = `${defaultHash}_${initTime}`;
          console.log(`ğŸ”§ [OAuth-Between] ä½¿ç”¨é»˜è®¤OAuth Hash: ${oauthHash}`);
        }
      }, 100);
    }
    
    console.log(`ğŸ¯ [OAuth-Between] ä½¿ç”¨å›ºå®šçš„OAuth Hash: ${oauthHash}`);

    function generateRandomString(length) {
      const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      const values = crypto.getRandomValues(new Uint8Array(length));
      return Array.from(values, x => possible[x % possible.length]).join('');
    }

    async function sha256(plain) {
      if (!window.crypto?.subtle) throw new Error('éœ€è¦ HTTPS ç¯å¢ƒ');
      const encoder = new TextEncoder();
      const data = encoder.encode(plain);
      const hash = await window.crypto.subtle.digest('SHA-256', data);
      return btoa(String.fromCharCode(...new Uint8Array(hash)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    async function startOAuth() {
      // ä½¿ç”¨å†…ç½®çš„ Client IDï¼Œè€Œä¸æ˜¯ä»è¾“å…¥æ¡†è·å–
      const clientId = 'Ov23liiGiIBKpOFbx68G'; // å†…ç½®çš„ Client IDï¼Œä¸é¡¹ç›®é…ç½®ä¸€è‡´
      if (!clientId) return showError('è¯·è¾“å…¥ Client ID');

      try {
        const codeVerifier = generateRandomString(128);
        const codeChallenge = await sha256(codeVerifier);
        sessionStorage.setItem('code_verifier', codeVerifier);
        sessionStorage.setItem('client_id', clientId);

        const authUrl = new URL('https://github.com/login/oauth/authorize');
        authUrl.searchParams.append('client_id', clientId);
        authUrl.searchParams.append('redirect_uri', REDIRECT_URI);
        authUrl.searchParams.append('scope', 'user:email');
        authUrl.searchParams.append('code_challenge', codeChallenge);
        authUrl.searchParams.append('code_challenge_method', 'S256');
        authUrl.searchParams.append('state', generateRandomString(32));

        window.location.href = authUrl.toString();
      } catch (e) {
        showError('å¯åŠ¨å¤±è´¥: ' + e.message);
      }
    }

    async function handleCallback() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      if (!code) return;

      showLoading(true);
      const codeVerifier = sessionStorage.getItem('code_verifier');
      const clientId = sessionStorage.getItem('client_id');

      if (!codeVerifier || !clientId) {
        showError('è®¤è¯å‚æ•°ä¸¢å¤±ï¼Œè¯·é‡æ–°ç™»å½•');
        showLoading(false);
        return;
      }

      try {
        // æ£€æŸ¥æ˜¯å¦åœ¨æ¡Œé¢ç¯å¢ƒä¸­
        if (window.EditorPreload && typeof window.EditorPreload.exchangeOAuthCode === 'function') {
          // åœ¨æ¡Œé¢ç¯å¢ƒä¸­ï¼Œé€šè¿‡æ¡Œé¢åº”ç”¨ä¸åç«¯é€šä¿¡
          const result = await window.EditorPreload.exchangeOAuthCode({
            code: code,
            code_verifier: codeVerifier,
            client_id: clientId,
            redirect_uri: REDIRECT_URI
          });
          const token = result.token;
          const user = result.user;
          const email = result.email;
          
          // ä¿å­˜åˆ° localStorage ä¾›æ¡Œé¢åº”ç”¨è¯»å–
          localStorage.setItem('github_token', token);
          localStorage.setItem('github_user', JSON.stringify(user));
          localStorage.setItem('github_email', email);

          // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
          window.history.replaceState({}, '', window.location.pathname);
          displayUserInfo(user, email, token);
          showLoading(false);
          
          // å°† token ä¼ é€’ç»™æ¡Œé¢ç«¯
          onTokenReceived(token);
        } else {
          // åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ï¼Œç›´æ¥ä¸åç«¯é€šä¿¡ï¼ˆå¯èƒ½é‡åˆ° CORS é—®é¢˜ï¼‰
          const res = await fetch(BACKEND_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              code: code,
              code_verifier: codeVerifier,
              client_id: clientId,
              redirect_uri: REDIRECT_URI  // å¿…é¡»ä¼ ï¼
            })
          });

          const data = await res.json();
          if (data.error) throw new Error(data.error_description || data.error);

          const token = data.access_token;

          const userRes = await fetch('https://api.github.com/user', {
            headers: { Authorization: `token ${token}`, 'User-Agent': 'OAuth-App' }
          });
          const user = await userRes.json();

          let email = user.email;
          if (!email) {
            const emailRes = await fetch('https://api.github.com/user/emails', {
              headers: { Authorization: `token ${token}`, 'User-Agent': 'OAuth-App' }
            });
            const emails = await emailRes.json();
            email = emails.find(e => e.primary)?.email || 'æœªå…¬å¼€';
          }

          // ä¿å­˜åˆ° localStorage ä¾›æ¡Œé¢åº”ç”¨è¯»å–
          localStorage.setItem('github_token', token);
          localStorage.setItem('github_user', JSON.stringify(user));
          localStorage.setItem('github_email', email);

          // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
          window.history.replaceState({}, '', window.location.pathname);
          displayUserInfo(user, email, token);
          showLoading(false);
          
          // å°† token ä¼ é€’ç»™æ¡Œé¢ç«¯
          onTokenReceived(token);
        }

      } catch (e) {
        showError('è®¤è¯å¤±è´¥: ' + e.message);
        showLoading(false);
      }
    }

    window.displayUserInfo = function(user, email, token) {
      const loginSectionEl = document.getElementById('login-section');
      const userInfoEl = document.getElementById('user-info');
      const userAvatarEl = document.getElementById('user-avatar');
      const usernameEl = document.getElementById('username');
      const nameEl = document.getElementById('name');
      const emailEl = document.getElementById('email');
      const publicReposEl = document.getElementById('public-repos');
      const tokenValueEl = document.getElementById('token-value');
      
      if (loginSectionEl) loginSectionEl.style.display = 'none';
      if (userInfoEl) userInfoEl.style.display = 'block';
      if (userAvatarEl) userAvatarEl.src = user.avatar_url;
      if (usernameEl) usernameEl.textContent = user.login;
      if (nameEl) nameEl.textContent = user.name || 'æœªè®¾ç½®';
      if (emailEl) emailEl.textContent = email;
      if (publicReposEl) publicReposEl.textContent = user.public_repos;
      if (tokenValueEl) tokenValueEl.textContent = token;
    };

    function copyToken() {
      navigator.clipboard.writeText(document.getElementById('token-value').textContent);
      const btn = event.target;
      const orig = btn.textContent;
      btn.textContent = 'å·²å¤åˆ¶';
      setTimeout(() => btn.textContent = orig, 2000);
    }

    function logout() {
      localStorage.clear();
      sessionStorage.clear();
      document.getElementById('user-info').style.display = 'none';
      document.getElementById('login-section').style.display = 'block';
    }

    function showError(msg) {
      const el = document.getElementById('error-message');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    function showLoading(show) {
      const loadingEl = document.getElementById('loading');
      const loginSectionEl = document.getElementById('login-section');
      const autoStartMessageEl = document.getElementById('auto-start-message');
      
      if (loadingEl) {
        loadingEl.style.display = show ? 'block' : 'none';
      }
      
      if (loginSectionEl) {
        loginSectionEl.style.display = show ? 'none' : 'block';
      }
      
      // åŒæ—¶å¤„ç†è‡ªåŠ¨å¯åŠ¨æ¶ˆæ¯å…ƒç´ 
      if (autoStartMessageEl) {
        autoStartMessageEl.style.display = show ? 'block' : 'none';
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      console.log(`ğŸš€ [OAuth-Between] é¡µé¢åŠ è½½å®Œæˆï¼Œæ—¶é—´: ${new Date().toLocaleString()}`);
      console.log(`ğŸ”— [OAuth-Between] å½“å‰URL: ${window.location.href}`);
      console.log(`ğŸ”‘ [OAuth-Between] OAuth Hash: ${oauthHash}`);
      console.log(`ğŸ’» [OAuth-Between] ç”¨æˆ·ä»£ç†: ${navigator.userAgent}`);
      console.log(`ğŸŒ [OAuth-Between] å½“å‰ä½ç½®: ${window.location.origin}`);
      
      const token = localStorage.getItem('github_token');
      const user = localStorage.getItem('github_user');
      const email = localStorage.getItem('github_email');
      console.log(`ğŸ’¾ [OAuth-Between] localStorageçŠ¶æ€: token=${!!token}, user=${!!user}, email=${!!email}`);
      
      if (token && user) displayUserInfo(JSON.parse(user), email, token);
      handleCallback();
      
      // æ£€æŸ¥æ˜¯å¦åœ¨å›è°ƒæµç¨‹ä¸­ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™è‡ªåŠ¨å¯åŠ¨ OAuth
      const params = new URLSearchParams(window.location.search);
      console.log(`ğŸ”„ [OAuth-Between] URLå‚æ•°: ${params.toString()}`);
      console.log(`ğŸ“ [OAuth-Between] æ˜¯å¦åŒ…å«code: ${params.has('code')}`);
      
      if (!params.has('code')) {
        // æ²¡æœ‰æˆæƒç ï¼Œè¯´æ˜ä¸æ˜¯å›è°ƒï¼Œè‡ªåŠ¨å¼€å§‹ OAuth
        console.log('ğŸ”„ [OAuth-Between] å‡†å¤‡å¯åŠ¨OAuthæµç¨‹...');
        setTimeout(() => {
          startOAuth();
        }, 1000); // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ­£åœ¨å¯åŠ¨çš„æ¶ˆæ¯
      } else {
        console.log('ğŸ”„ [OAuth-Between] æ­£åœ¨å¤„ç†OAuthå›è°ƒ...');
      }
    });

    // OAuthæµç¨‹ç°åœ¨ä½¿ç”¨localStorageï¼Œä¸éœ€è¦ç›´æ¥HTTPé€šä¿¡

    // åœ¨è·å–åˆ°tokenåè°ƒç”¨è¿™ä¸ªå‡½æ•°
    async function onTokenReceived(token) {
      try {
        // å°†tokenå­˜å‚¨åˆ°localStorage
        const storageKey = `oauth_token_${oauthHash}`;
        localStorage.setItem(storageKey, token);
        
        // åŒæ—¶å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
        const userInfo = {
          token: token,
          timestamp: Date.now()
        };
        localStorage.setItem(`oauth_user_${oauthHash}`, JSON.stringify(userInfo));
        
        console.log('Tokenå·²å­˜å‚¨åˆ°localStorage:', storageKey);
        
        // å‘äº‘ç«¯APIå‘é€tokenç”¨äºä¸´æ—¶è·¯ç”±è®¿é—®
        await sendTokenToCloud(oauthHash, token);
        
        // ç¨åå…³é—­çª—å£
        setTimeout(() => {
          window.close();
        }, 1500);
      } catch (error) {
        console.error('å¤„ç†tokenå¤±è´¥:', error);
        
        // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ç®€å•çš„æ—¶é—´æˆ³
        const backupKey = `oauth_token_backup_${oauthHash}`;
        localStorage.setItem(backupKey, token);
        console.log('ä½¿ç”¨å¤‡ç”¨keyå­˜å‚¨token:', backupKey);
        
        setTimeout(() => {
          window.close();
        }, 1500);
      }
    }

    // å‘äº‘ç«¯å‘é€tokenç”¨äºä¸´æ—¶è·¯ç”±
    async function sendTokenToCloud(hash, token) {
      try {
        console.log(`ğŸŒ [OAuth-Between] å‡†å¤‡å‘é€tokenåˆ°äº‘ç«¯ï¼Œhash=${hash.substring(0, 20)}...`);
        console.log(`ğŸ” [OAuth-Between] Tokené•¿åº¦: ${token.length}`);
        
        const backendUrl = 'https://02engine-desktop-oauth-backend.netlify.app/.netlify/functions/store-token';
        console.log(`ğŸ“¡ [OAuth-Between] å‘é€è¯·æ±‚åˆ°: ${backendUrl}`);
        
        const response = await fetch(backendUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            hash: hash,
            token: token
          })
        });
        
        console.log(`ğŸ“Š [OAuth-Between] æœåŠ¡å™¨å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
        
        if (!response.ok) {
          console.error(`âŒ [OAuth-Between] æœåŠ¡å™¨é”™è¯¯: ${response.status} ${response.statusText}`);
          return;
        }
        
        const result = await response.json();
        console.log(`ğŸ“‹ [OAuth-Between] æœåŠ¡å™¨å“åº”å†…å®¹:`, result);
        
        if (result.success) {
          console.log(`âœ… [OAuth-Between] Tokenå·²æˆåŠŸå‘é€åˆ°äº‘ç«¯`);
          console.log(`ğŸ”— [OAuth-Between] ä¸´æ—¶è·¯ç”±: /temp-token/${hash}`);
          console.log(`ğŸ’» [OAuth-Between] æ¡Œé¢ç«¯å¯ä»¥é€šè¿‡è®¿é—®è¯¥URLè·å–token`);
        } else {
          console.error(`âŒ [OAuth-Between] å‘é€tokenåˆ°äº‘ç«¯å¤±è´¥:`, result.error);
        }
      } catch (error) {
        console.error(`âŒ [OAuth-Between] å‘é€tokenåˆ°äº‘ç«¯å‡ºé”™:`, error.message);
        console.error(`ğŸ“Š [OAuth-Between] é”™è¯¯è¯¦æƒ…:`, error);
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯CORSé—®é¢˜
        if (error.message.includes('CORS') || error.message.includes('NetworkError')) {
          console.log(`ğŸ”„ [OAuth-Between] æ£€æµ‹åˆ°CORSæˆ–ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯é…ç½®`);
        }
      }
    }

    // æ£€æŸ¥æ¡Œé¢ç¯å¢ƒå¹¶è‡ªåŠ¨å…³é—­çª—å£
    function checkDesktopAndClose() {
      if (window.EditorPreload) {
        // åœ¨æ¡Œé¢ç¯å¢ƒä¸­ï¼Œé€šçŸ¥åº”ç”¨tokenå·²æ¥æ”¶å¹¶å…³é—­çª—å£
        setTimeout(() => {
          window.close();
        }, 1500); // ç»™ç”¨æˆ·ä¸€ç‚¹æ—¶é—´çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
      }
    }

    // ä¿®æ”¹displayUserInfoå‡½æ•°ï¼Œä»¥ä¾¿åœ¨æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯åè‡ªåŠ¨å‘é€token
    const originalDisplayUserInfo = displayUserInfo;
    displayUserInfo = function(user, email, token) {
      originalDisplayUserInfo(user, email, token);
      onTokenReceived(token);
      checkDesktopAndClose();
    };
  </script>
</body>
</html>

